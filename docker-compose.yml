version: '3.9'

services:
  master:
    container_name: "${COMPOSE_PROJECT_NAME:-citus}_master"
    image: "citusdata/citus:11.3.0"
    ports: [ "${COORDINATOR_EXTERNAL_PORT:-5432}:5432" ]
    labels: [ "com.citusdata.role=Master" ]
    volumes:
      - ./sharding/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment: &AUTH
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      PGUSER: "${POSTGRES_USER:-postgres}"
      PGPASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_HOST_AUTH_METHOD: "${POSTGRES_HOST_AUTH_METHOD:-trust}"

  worker:
    image: "citusdata/citus:11.3.0"
    labels: [ "com.citusdata.role=Worker" ]
    depends_on: [ manager ]
    environment: *AUTH
    command: "/wait-for-manager.sh"
    volumes:
      - healthcheck-volume:/healthcheck

  manager:
    container_name: "${COMPOSE_PROJECT_NAME:-citus}_manager"
    image: "citusdata/membership-manager:0.3.0"
    volumes:
      - "${DOCKER_SOCK:-/var/run/docker.sock}:/var/run/docker.sock"
      - healthcheck-volume:/healthcheck
    depends_on: [ master ]
    environment: *AUTH

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
      # Admin http://localhost:15672/ guest / guest

  tarantool:
    container_name: "tarantool"
    image: tarantool/tarantool:latest
    ports:
      - "3301:3301"
    volumes:
      - ./tarantool/conf/init.lua:/opt/tarantool/init.lua
      - ./tarantool/data:/var/lib/tarantool

  otus-app:
    image: otus-app:latest
    depends_on:
      - master
      - rabbitmq
    ports:
      - '8080:8080'
    environment:
      SPRING_APPLICATION_JSON: '{
               "spring.liquibase.url": "jdbc:postgresql://master:5432/postgres?autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true",
               "spring.datasource.url": "jdbc:postgresql://master:5432/postgres?useSSL=false&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true",
               "spring.r2dbc.url": "r2dbc:pool:postgresql://master/postgres?tlsVersion=TLSv1.2",
               "spring.datasource.replicaUrl": "jdbc:postgresql://master:5432/postgres?useSSL=false&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true",
               "spring.rabbitmq.host": "rabbitmq",
               "spring.rabbitmq.port": 5672,
               "otus.dialoguesHost": "http://otus-dialogues-app:8081"       
             }'
    volumes:
      - .m2:/root/.m2
    stdin_open: true
    tty: true

  otus-dialogues-app:
    image: otus-dialogues-app:latest
    depends_on:
      - tarantool
    ports:
      - '8081:8081'
    environment:
      SPRING_APPLICATION_JSON: '{
               "spring.datasource.url": "jdbc:postgresql://master:5432/postgres?useSSL=false&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true",
               "spring.r2dbc.url": "r2dbc:pool:postgresql://master/postgres?tlsVersion=TLSv1.2",
               "spring.datasource.replicaUrl": "jdbc:postgresql://master:5432/postgres?useSSL=false&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true",
               "tarantool.host": "tarantool",
               "tarantool.port": 3301
             }'

volumes:
  healthcheck-volume:
