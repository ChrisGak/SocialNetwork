version: '3.9'

services:
  master:
    container_name: "${COMPOSE_PROJECT_NAME:-citus}_master"
    image: "citusdata/citus:11.3.0"
    ports: [ "${COORDINATOR_EXTERNAL_PORT:-5432}:5432" ]
    labels: [ "com.citusdata.role=Master" ]
    volumes:
      - ./sharding/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment: &AUTH
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      PGUSER: "${POSTGRES_USER:-postgres}"
      PGPASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_HOST_AUTH_METHOD: "${POSTGRES_HOST_AUTH_METHOD:-trust}"
  worker:
    image: "citusdata/citus:11.3.0"
    labels: [ "com.citusdata.role=Worker" ]
    depends_on: [ manager ]
    environment: *AUTH
    command: "/wait-for-manager.sh"
    volumes:
      - healthcheck-volume:/healthcheck
  manager:
    container_name: "${COMPOSE_PROJECT_NAME:-citus}_manager"
    image: "citusdata/membership-manager:0.3.0"
    volumes:
      - "${DOCKER_SOCK:-/var/run/docker.sock}:/var/run/docker.sock"
      - healthcheck-volume:/healthcheck
    depends_on: [ master ]
    environment: *AUTH
  otus-app:
    image: otus-app:latest
    depends_on:
      - master
    restart: unless-stopped
    ports:
      - '8080:8080'
    environment:
      SPRING_APPLICATION_JSON: '{
               "spring.liquibase.url" : "jdbc:postgresql://master:5432/postgres?autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true",
               "spring.datasource.url" : "jdbc:postgresql://master:5432/postgres?useSSL=false&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true",
               "spring.r2dbc.url" : "r2dbc:pool:postgresql://master/postgres?tlsVersion=TLSv1.2",
               "spring.datasource.replicaUrl" : "jdbc:postgresql://master:5432/postgres?useSSL=false&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true"
             }'
    volumes:
      - .m2:/root/.m2
    stdin_open: true
    tty: true

volumes:
  healthcheck-volume:
